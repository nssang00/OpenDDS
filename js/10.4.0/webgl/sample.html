<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebGL 인스턴스 삼각형 최소 예제</title>
    <style>
        body { background: #111; }
        canvas { display: block; margin: 40px auto; background: #000; }
    </style>
</head>
<body>
<canvas id="glcanvas" width="600" height="400"></canvas>
<script>
    // --- 1. WebGL 및 확장 초기화 ---
    const canvas = document.getElementById('glcanvas');
    const gl = canvas.getContext('webgl');
    if (!gl) { alert('WebGL 미지원'); throw 'WebGL 미지원'; }
    const ext = gl.getExtension('ANGLE_instanced_arrays');
    if (!ext) { alert('ANGLE_instanced_arrays 미지원'); throw 'ANGLE_instanced_arrays 미지원'; }

    // --- 2. 셰이더 코드 ---
    const vs = `
        attribute vec2 a_position;
        attribute vec2 a_instancePosition;
        attribute vec3 a_instanceColor;
        varying vec3 v_color;
        void main() {
            vec2 pos = a_position * 0.2 + a_instancePosition;
            gl_Position = vec4(pos, 0, 1);
            v_color = a_instanceColor;
        }
    `;
    const fs = `
        precision mediump float;
        varying vec3 v_color;
        void main() {
            gl_FragColor = vec4(v_color, 1.0);
        }
    `;

    // --- 3. 셰이더/프로그램 빌드 ---
    function compile(type, src) {
        const sh = gl.createShader(type);
        gl.shaderSource(sh, src); gl.compileShader(sh);
        if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) {
            throw gl.getShaderInfoLog(sh);
        }
        return sh;
    }
    const prog = gl.createProgram();
    gl.attachShader(prog, compile(gl.VERTEX_SHADER, vs));
    gl.attachShader(prog, compile(gl.FRAGMENT_SHADER, fs));
    gl.linkProgram(prog);
    if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) throw gl.getProgramInfoLog(prog);

    // --- 4. 정점/인덱스/인스턴스 버퍼 생성 ---
    // (1) 삼각형 정점
    const vertexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
        0.0,  0.5,
       -0.5, -0.5,
        0.5, -0.5
    ]), gl.STATIC_DRAW);

    // (2) 인덱스 (삼각형 하나)
    const indexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([0, 1, 2]), gl.STATIC_DRAW);

    // (3) 인스턴스 위치 (x, y 3개)
    const positions = new Float32Array([
        -0.7, 0.0,
         0.0, 0.0,
         0.7, 0.0
    ]);
    const positionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);

    // (4) 인스턴스 색상 (r,g,b 3개)
    const colors = new Float32Array([
        1.0, 0.0, 0.0, // 빨강
        0.0, 1.0, 0.0, // 초록
        0.0, 0.0, 1.0  // 파랑
    ]);
    const colorBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);

    // --- 5. attribute 연결 ---
    gl.useProgram(prog);

    // (1) 삼각형 정점
    const a_position = gl.getAttribLocation(prog, "a_position");
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
    gl.enableVertexAttribArray(a_position);
    gl.vertexAttribPointer(a_position, 2, gl.FLOAT, false, 0, 0);

    // (2) 인스턴스 위치
    const a_instancePosition = gl.getAttribLocation(prog, "a_instancePosition");
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
    gl.enableVertexAttribArray(a_instancePosition);
    gl.vertexAttribPointer(a_instancePosition, 2, gl.FLOAT, false, 0, 0);
    ext.vertexAttribDivisorANGLE(a_instancePosition, 1); // 인스턴스 단위

    // (3) 인스턴스 색상
    const a_instanceColor = gl.getAttribLocation(prog, "a_instanceColor");
    gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
    gl.enableVertexAttribArray(a_instanceColor);
    gl.vertexAttribPointer(a_instanceColor, 3, gl.FLOAT, false, 0, 0);
    ext.vertexAttribDivisorANGLE(a_instanceColor, 1); // 인스턴스 단위

    // (4) 인덱스 버퍼 바인딩
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);

    // --- 6. 화면 클리어 및 인스턴스 렌더링 ---
    gl.clearColor(0, 0, 0, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);

    ext.drawElementsInstancedANGLE(
        gl.TRIANGLES,      // mode
        3,                 // count (인덱스 개수, 삼각형 1개)
        gl.UNSIGNED_SHORT, // type
        0,                 // offset
        3                  // instanceCount (3개 인스턴스)
    );
</script>
</body>
</html>
