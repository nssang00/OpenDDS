<!DOCTYPE html>
<html>
<head>
    <title>GeoJSON WebGL 렌더링</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { width: 100vw; height: 100vh; display: block; }
    </style>
</head>
<body>
    <canvas id="glCanvas"></canvas>

<script>
// WebGL 컨텍스트 초기화
const canvas = document.getElementById('glCanvas');
const gl = canvas.getContext('webgl');

// GeoJSON 샘플 데이터
const geoJson = {
    "type": "FeatureCollection",
    "features": [
        {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [0.5, 0.5]
            }
        },
        {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": [[0.1, 0.1], [0.9, 0.9]]
            }
        },
        {
            "type": "Feature",
            "geometry": {
                "type": "Polygon",
                "coordinates": [[[0.2,0.2], [0.8,0.2], [0.5,0.8], [0.2,0.2]]]
            }
        }
    ]
};

// 쉐이더 초기화 함수
function initShaders(vertexSrc, fragmentSrc) {
    const vertexShader = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vertexShader, vertexSrc);
    gl.compileShader(vertexShader);

    const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fragmentShader, fragmentSrc);
    gl.compileShader(fragmentShader);

    const program = gl.createProgram();
    gl.attachShader(program, vertexShader);
    gl.attachShader(program, fragmentShader);
    gl.linkProgram(program);

    return program;
}

// 쉐이더 소스 코드
const vertexShaderSource = `
attribute vec2 aPosition;
uniform mat3 uTransform;

void main() {
    vec3 pos = uTransform * vec3(aPosition, 1.0);
    gl_Position = vec4(pos.xy, 0.0, 1.0);
    gl_PointSize = 10.0;
}
`;

const fragmentShaderSource = `
precision mediump float;
uniform vec4 uColor;

void main() {
    gl_FragColor = uColor;
}
`;

// 변환 매트릭스 (정규화 좌표 → WebGL 클립공간)
const transform = new Float32Array([
    2, 0, -1,
    0, 2, -1,
    0, 0, 1
]);

// 스타일 정의
const styles = {
    Point: { color: [1, 0, 0, 1] },          // 빨간색 점
    LineString: { color: [0, 1, 0, 1],       // 초록색 선
                 lineWidth: 3 },             // 선 두께 3픽셀
    Polygon: { color: [0, 0, 1, 0.5] }       // 반투명 파란색 폴리곤
};

// WebGL 프로그램 초기화
const program = initShaders(vertexShaderSource, fragmentShaderSource);
gl.useProgram(program);

// 버퍼 생성 함수
function createBuffer(data) {
    const buffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(data), gl.STATIC_DRAW);
    return buffer;
}

// 렌더링 함수
function renderFeature(feature) {
    const geom = feature.geometry;
    const style = styles[geom.type];
    
    gl.uniform4fv(gl.getUniformLocation(program, 'uColor'), style.color);

    switch(geom.type) {
        case 'Point':
            const pointCoords = geom.coordinates;
            const pointBuffer = createBuffer(pointCoords);
            gl.bindBuffer(gl.ARRAY_BUFFER, pointBuffer);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(0);
            gl.drawArrays(gl.POINTS, 0, 1);
            break;

        case 'LineString':
            const lineCoords = geom.coordinates.flat();
            const lineBuffer = createBuffer(lineCoords);
            gl.bindBuffer(gl.ARRAY_BUFFER, lineBuffer);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(0);
            gl.lineWidth(style.lineWidth);
            gl.drawArrays(gl.LINE_STRIP, 0, lineCoords.length/2);
            break;

        case 'Polygon':
            const polyCoords = geom.coordinates[0].flat();
            const polyBuffer = createBuffer(polyCoords);
            gl.bindBuffer(gl.ARRAY_BUFFER, polyBuffer);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(0);
            gl.drawArrays(gl.TRIANGLE_FAN, 0, polyCoords.length/2);
            break;
    }
}

// 렌더링 준비
function render() {
    gl.clearColor(1, 1, 1, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);
    
    gl.uniformMatrix3fv(
        gl.getUniformLocation(program, 'uTransform'),
        false,
        transform
    );
    
    geoJson.features.forEach(renderFeature);
}

// 창 크기 조정 핸들러
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    gl.viewport(0, 0, canvas.width, canvas.height);
    render();
}

// 이벤트 리스너 등록
window.addEventListener('resize', resize);
resize();
</script>
</body>
</html>
