import React, { useState, useEffect } from 'react';

const XMIToMermaid = () => {
  const [xmiInput, setXmiInput] = useState('');
  const [parsedData, setParsedData] = useState(null);
  const [mermaidCode, setMermaidCode] = useState('');
  const [error, setError] = useState('');

  // XMI 파싱 함수
  const parseXMI = (xmiText) => {
    try {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmiText, 'text/xml');
      
      // 파싱 에러 체크
      const parserError = xmlDoc.querySelector('parsererror');
      if (parserError) {
        throw new Error('XML 파싱 에러: ' + parserError.textContent);
      }

      const result = {
        packages: [],
        classes: [],
        primitiveTypes: [],
        stereotypes: {}
      };

      // 모든 packagedElement 가져오기
      const allElements = xmlDoc.getElementsByTagName('packagedElement');
      
      // 패키지와 클래스 파싱
      for (let i = 0; i < allElements.length; i++) {
        const element = allElements[i];
        const xmiType = element.getAttribute('xmi:type');
        
        if (xmiType === 'uml:Package') {
          const packageInfo = {
            id: element.getAttribute('xmi:id'),
            name: element.getAttribute('name'),
            visibility: element.getAttribute('visibility'),
            children: []
          };
          result.packages.push(packageInfo);
        } else if (xmiType === 'uml:Class') {
          const classInfo = {
            id: element.getAttribute('xmi:id'),
            name: element.getAttribute('name'),
            visibility: element.getAttribute('visibility'),
            attributes: [],
            stereotypes: []
          };

          // 속성 파싱
          const attributes = element.getElementsByTagName('ownedAttribute');
          for (let j = 0; j < attributes.length; j++) {
            const attr = attributes[j];
            const attrType = attr.getAttribute('xmi:type');
            
            if (attrType === 'uml:Property') {
              const attrId = attr.getAttribute('xmi:id');
              
              // lowerValue와 upperValue 찾기
              const lowerValues = attr.getElementsByTagName('lowerValue');
              const upperValues = attr.getElementsByTagName('upperValue');
              const types = attr.getElementsByTagName('type');
              
              const attributeInfo = {
                id: attrId,
                name: attr.getAttribute('name'),
                visibility: attr.getAttribute('visibility'),
                isStatic: attr.getAttribute('isStatic') === 'true',
                isReadOnly: attr.getAttribute('isReadOnly') === 'true',
                multiplicity: {
                  lower: lowerValues.length > 0 ? lowerValues[0].getAttribute('value') : '1',
                  upper: upperValues.length > 0 ? upperValues[0].getAttribute('value') : '1'
                },
                type: types.length > 0 ? types[0].getAttribute('xmi:idref') : 'unknown',
                stereotypes: []
              };

              classInfo.attributes.push(attributeInfo);
            }
          }

          result.classes.push(classInfo);
        } else if (xmiType === 'uml:PrimitiveType') {
          result.primitiveTypes.push({
            id: element.getAttribute('xmi:id'),
            name: element.getAttribute('name')
          });
        }
      }

      // Stereotype 적용 파싱 - 모든 태그를 검사
      const allTags = xmlDoc.getElementsByTagName('*');
      for (let i = 0; i < allTags.length; i++) {
        const tag = allTags[i];
        const tagName = tag.tagName;
        
        // thecustomprofile: 로 시작하는 태그 찾기
        if (tagName.startsWith('thecustomprofile:')) {
          const stereotypeName = tagName.split(':')[1];
          const baseElement = tag.getAttribute('base_Class') || tag.getAttribute('base_Property');
          
          if (baseElement) {
            if (!result.stereotypes[baseElement]) {
              result.stereotypes[baseElement] = [];
            }
            result.stereotypes[baseElement].push(stereotypeName);
          }
        }
      }

      // 클래스와 속성에 stereotype 정보 추가
      result.classes.forEach(cls => {
        if (result.stereotypes[cls.id]) {
          cls.stereotypes = result.stereotypes[cls.id];
        }
        
        cls.attributes.forEach(attr => {
          if (result.stereotypes[attr.id]) {
            attr.stereotypes = result.stereotypes[attr.id];
          }
        });
      });

      console.log('Parse complete:', {
        packages: result.packages.length,
        classes: result.classes.length,
        primitiveTypes: result.primitiveTypes.length,
        stereotypes: Object.keys(result.stereotypes).length
      });

      return result;
    } catch (err) {
      throw new Error('XMI 파싱 중 오류 발생: ' + err.message);
    }
  };

  // JSON을 Mermaid 코드로 변환
  const jsonToMermaid = (data) => {
    if (!data.classes || data.classes.length === 0) {
      return 'classDiagram\n  class Empty {\n    +String message\n  }\n  note for Empty "클래스를 찾을 수 없습니다"';
    }
    
    let mermaid = 'classDiagram\n';
    
    data.classes.forEach(cls => {
      // 클래스 선언
      mermaid += `  class ${cls.name} {\n`;
      
      // 속성 추가
      cls.attributes.forEach(attr => {
        const visibilitySymbol = {
          'private': '-',
          'public': '+',
          'protected': '#',
          'package': '~'
        }[attr.visibility] || '-';
        
        // 타입 이름 추출 (EAJava_ 제거)
        let typeName = attr.type.replace('EAJava_', '');
        
        // Primitive type에서 실제 이름 찾기
        const primitiveType = data.primitiveTypes.find(pt => pt.id === attr.type);
        if (primitiveType) {
          typeName = primitiveType.name;
        }
        
        // Stereotype 표시
        const stereoStr = attr.stereotypes.length > 0 
          ? ` <<${attr.stereotypes.join(', ')}>>` 
          : '';
        
        // Multiplicity 표시
        const multiplicity = attr.multiplicity.upper === '1' ? '' : `[${attr.multiplicity.lower}..${attr.multiplicity.upper}]`;
        
        mermaid += `    ${visibilitySymbol}${typeName} ${attr.name}${multiplicity}${stereoStr}\n`;
      });
      
      mermaid += `  }\n`;
      
      // 클래스 stereotype을 note로 추가
      if (cls.stereotypes.length > 0) {
        mermaid += `  note for ${cls.name} "<<${cls.stereotypes.join(', ')}>>"\n`;
      }
      
      mermaid += '\n';
    });
    
    return mermaid;
  };

  // XMI 파싱 및 Mermaid 생성
  const handleParse = () => {
    setError('');
    try {
      const parsed = parseXMI(xmiInput);
      console.log('Parsed data:', parsed);
      console.log('Classes found:', parsed.classes.length);
      console.log('Primitive types found:', parsed.primitiveTypes.length);
      
      setParsedData(parsed);
      const mermaid = jsonToMermaid(parsed);
      setMermaidCode(mermaid);
    } catch (err) {
      setError(err.message);
      setParsedData(null);
      setMermaidCode('');
    }
  };

  // 샘플 XMI 로드
  const loadSample = async () => {
    const sampleXMI = `<?xml  version='1.0' encoding='windows-1252' ?>
<xmi:XMI xmlns:xmi="http://schema.omg.org/spec/XMI/2.1" xmi:version="2.1" xmlns:uml="http://schema.omg.org/spec/UML/2.1" xmlns:thecustomprofile="http://www.sparxsystems.com/profiles/thecustomprofile/1.0">
  <xmi:Documentation exporter="Enterprise Architect" exporterVersion="6.5" exporterID="1716"/>
  <uml:Model xmi:type="uml:Model" name="EA_Model" visibility="public">
    <packagedElement xmi:type="uml:Package" xmi:id="EAPK_8A928EC0_FA27_41b8_B777_3AD0566D730C" name="Model" visibility="public">
      <packagedElement xmi:type="uml:Package" xmi:id="EAPK_E916A60A_CE89_4890_BC94_774A20010D63" name="UMAA_Standard" visibility="public">
        <packagedElement xmi:type="uml:Package" xmi:id="EAPK_EF77C4AB_9B09_4e7a_830F_E9A319FC757E" name="SA" visibility="public">
          <packagedElement xmi:type="uml:Package" xmi:id="EAPK_B1AAC945_1F55_42fc_9839_88E169307909" name="VelocityStatus" visibility="public">
            <packagedElement xmi:type="uml:Class" xmi:id="EAID_3EB86C99_A146_4cf4_8876_DEFC38F717FD" name="VelocityReportType" visibility="public">
              <ownedAttribute xmi:type="uml:Property" xmi:id="EAID_DB0A4A7E_8202_4069_99C4_DB54AB5D4EED" name="attitudeRate" visibility="private" isStatic="false" isReadOnly="false" isDerived="false" isOrdered="false" isUnique="true" isDerivedUnion="false">
                <lowerValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000001_8202_4069_99C4_DB54AB5D4EED" value="1"/>
                <upperValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000002_8202_4069_99C4_DB54AB5D4EED" value="1"/>
                <type xmi:idref="EAJava_OrientationVel3D"/>
              </ownedAttribute>
              <ownedAttribute xmi:type="uml:Property" xmi:id="EAID_E054E33D_6122_4e26_8A1B_D1584E69D90F" name="attitudeRateCovariance" visibility="private" isStatic="false" isReadOnly="false" isDerived="false" isOrdered="false" isUnique="true" isDerivedUnion="false">
                <lowerValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000003_6122_4e26_8A1B_D1584E69D90F" value="1"/>
                <upperValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000004_6122_4e26_8A1B_D1584E69D90F" value="1"/>
                <type xmi:idref="EAJava_CovarianceOrientationVelocityNEDType"/>
              </ownedAttribute>
              <ownedAttribute xmi:type="uml:Property" xmi:id="EAID_8AB97351_225A_41db_95CA_98E3E1C062A9" name="source" visibility="private" isStatic="false" isReadOnly="false" isDerived="false" isOrdered="false" isUnique="true" isDerivedUnion="false">
                <lowerValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000005_225A_41db_95CA_98E3E1C062A9" value="1"/>
                <upperValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000006_225A_41db_95CA_98E3E1C062A9" value="1"/>
                <type xmi:idref="EAJava_IdentifierType"/>
              </ownedAttribute>
              <ownedAttribute xmi:type="uml:Property" xmi:id="EAID_F31DA7FB_2B57_4339_AFE8_7E6BFFF395CD" name="timeStamp" visibility="private" isStatic="false" isReadOnly="false" isDerived="false" isOrdered="false" isUnique="true" isDerivedUnion="false">
                <lowerValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000007_2B57_4339_AFE8_7E6BFFF395CD" value="1"/>
                <upperValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000008_2B57_4339_AFE8_7E6BFFF395CD" value="1"/>
                <type xmi:idref="EAJava_DateTime"/>
              </ownedAttribute>
              <ownedAttribute xmi:type="uml:Property" xmi:id="EAID_A909C670_C760_4f6e_B5D0_890A64023054" name="velocity" visibility="private" isStatic="false" isReadOnly="false" isDerived="false" isOrdered="false" isUnique="true" isDerivedUnion="false">
                <lowerValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000009_C760_4f6e_B5D0_890A64023054" value="1"/>
                <upperValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000010_C760_4f6e_B5D0_890A64023054" value="1"/>
                <type xmi:idref="EAJava_Velocity3DPlatformNEDType"/>
              </ownedAttribute>
              <ownedAttribute xmi:type="uml:Property" xmi:id="EAID_E456F2D8_A6F2_41d3_882E_58EDB13F3B44" name="velocityCovariance" visibility="private" isStatic="false" isReadOnly="false" isDerived="false" isOrdered="false" isUnique="true" isDerivedUnion="false">
                <lowerValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000011_A6F2_41d3_882E_58EDB13F3B44" value="1"/>
                <upperValue xmi:type="uml:LiteralInteger" xmi:id="EAID_LI000012_A6F2_41d3_882E_58EDB13F3B44" value="1"/>
                <type xmi:idref="EAJava_CovarianceVelocityNEDType"/>
              </ownedAttribute>
            </packagedElement>
          </packagedElement>
        </packagedElement>
      </packagedElement>
    </packagedElement>
    <thecustomprofile:IDL_Struct base_Class="EAID_3EB86C99_A146_4cf4_8876_DEFC38F717FD"/>
    <thecustomprofile:UMAAOptional base_Property="EAID_E054E33D_6122_4e26_8A1B_D1584E69D90F"/>
    <thecustomprofile:key base_Property="EAID_8AB97351_225A_41db_95CA_98E3E1C062A9"/>
    <thecustomprofile:UMAAOptional base_Property="EAID_E456F2D8_A6F2_41d3_882E_58EDB13F3B44"/>
  </uml:Model>
  <primitivetypes>
    <packagedElement xmi:type="uml:Package" xmi:id="EAPrimitiveTypesPackage" name="EA_PrimitiveTypes">
      <packagedElement xmi:type="uml:Package" xmi:id="EAJavaPackage" name="EA_Java">
        <packagedElement xmi:type="uml:PrimitiveType" xmi:id="EAJava_OrientationVel3D" name="OrientationVel3D" visibility="public"/>
        <packagedElement xmi:type="uml:PrimitiveType" xmi:id="EAJava_CovarianceOrientationVelocityNEDType" name="CovarianceOrientationVelocityNEDType" visibility="public"/>
        <packagedElement xmi:type="uml:PrimitiveType" xmi:id="EAJava_IdentifierType" name="IdentifierType" visibility="public"/>
        <packagedElement xmi:type="uml:PrimitiveType" xmi:id="EAJava_DateTime" name="DateTime" visibility="public"/>
        <packagedElement xmi:type="uml:PrimitiveType" xmi:id="EAJava_Velocity3DPlatformNEDType" name="Velocity3DPlatformNEDType" visibility="public"/>
        <packagedElement xmi:type="uml:PrimitiveType" xmi:id="EAJava_CovarianceVelocityNEDType" name="CovarianceVelocityNEDType" visibility="public"/>
      </packagedElement>
    </packagedElement>
  </primitivetypes>
</xmi:XMI>`;
    
    setXmiInput(sampleXMI);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-2xl shadow-2xl p-8 mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">XMI to Mermaid Converter</h1>
          <p className="text-gray-600 mb-6">UML XMI 파일을 파싱하여 Mermaid 클래스 다이어그램으로 변환합니다</p>
          
          <div className="mb-6">
            <div className="flex gap-4 mb-4">
              <button
                onClick={loadSample}
                className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md"
              >
                샘플 XMI 로드
              </button>
              <button
                onClick={handleParse}
                disabled={!xmiInput}
                className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors shadow-md"
              >
                파싱 및 변환
              </button>
            </div>
            
            <div className="mb-4">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                XMI 입력:
              </label>
              <textarea
                value={xmiInput}
                onChange={(e) => setXmiInput(e.target.value)}
                placeholder="XMI 내용을 입력하거나 '샘플 XMI 로드' 버튼을 클릭하세요..."
                className="w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all font-mono text-sm"
              />
            </div>
          </div>

          {error && (
            <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
              <p className="text-red-700 font-semibold">오류:</p>
              <p className="text-red-600">{error}</p>
            </div>
          )}

          {parsedData && (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-800 mb-3">파싱된 JSON</h2>
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-gray-200 max-h-96 overflow-auto">
                  <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                    {JSON.stringify(parsedData, null, 2)}
                  </pre>
                </div>
              </div>
              
              <div>
                <h2 className="text-2xl font-bold text-gray-800 mb-3">Mermaid 코드</h2>
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-gray-200 max-h-96 overflow-auto">
                  <pre className="text-sm text-gray-800 whitespace-pre-wrap font-mono">
                    {mermaidCode}
                  </pre>
                </div>
                <button
                  onClick={() => navigator.clipboard.writeText(mermaidCode)}
                  className="mt-3 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors shadow-md text-sm"
                >
                  코드 복사
                </button>
              </div>
            </div>
          )}

          {mermaidCode && (
            <div className="mt-8">
              <h2 className="text-2xl font-bold text-gray-800 mb-3">Mermaid 다이어그램 미리보기</h2>
              <div className="bg-white p-8 rounded-lg border-2 border-gray-200 overflow-auto shadow-inner">
                <MermaidDiagram code={mermaidCode} />
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// Mermaid 렌더링 컴포넌트
const MermaidDiagram = ({ code }) => {
  const [svg, setSvg] = useState('');
  const [error, setError] = useState('');

  useEffect(() => {
    const renderDiagram = async () => {
      try {
        // Mermaid 라이브러리 동적 로드
        if (!window.mermaid) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
          script.onload = () => {
            window.mermaid.initialize({ 
              startOnLoad: false,
              theme: 'default',
              securityLevel: 'loose'
            });
            renderMermaid();
          };
          document.head.appendChild(script);
        } else {
          renderMermaid();
        }
      } catch (err) {
        setError('Mermaid 렌더링 오류: ' + err.message);
      }
    };

    const renderMermaid = async () => {
      try {
        const { svg } = await window.mermaid.render('mermaid-diagram-' + Date.now(), code);
        setSvg(svg);
        setError('');
      } catch (err) {
        setError('다이어그램 렌더링 오류: ' + err.message);
        setSvg('');
      }
    };

    if (code) {
      renderDiagram();
    }
  }, [code]);

  if (error) {
    return (
      <div className="p-4 bg-red-50 border-l-4 border-red-500 rounded">
        <p className="text-red-700">{error}</p>
      </div>
    );
  }

  return (
    <div 
      className="mermaid-container flex justify-center items-center"
      dangerouslySetInnerHTML={{ __html: svg }}
    />
  );
};

export default XMIToMermaid;
