// 총 필요한 크기 계산
const numCircles = 10000; // 원 개수
const segments = 30; // 각 원의 세그먼트 개수
const vertices = new Float32Array(numCircles * segments * 2); // 각 점당 x, y 좌표 2개
const colors = new Float32Array(numCircles * 4); // 각 원당 RGBA 색상 4개

// 애니메이션 함수
function animate() {
  gl.clear(gl.COLOR_BUFFER_BIT);

  // 모든 원의 랜덤 위치 및 색상 업데이트
  for (let i = 0; i < numCircles; i++) {
    const x = Math.random() * 2 - 1; // -1 ~ 1 범위
    const y = Math.random() * 2 - 1; // -1 ~ 1 범위
    const radius = Math.random() * 0.1 + 0.05; // 0.05 ~ 0.15

    // 각 원의 좌표 생성
    const circleVertices = generateCircleVertices(x, y, radius, segments);

    // `vertices` 배열에 좌표 설정
    const offset = i * segments * 2; // 각 원의 시작 오프셋
    vertices.set(circleVertices, offset); // 원의 좌표 저장

    // 색상 업데이트
    const color = getRandomColor();
    colors.set(color, i * 4); // 각 원의 RGBA 색상 저장
  }

  // GPU로 데이터 전송
  gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
  gl.bufferSubData(gl.ARRAY_BUFFER, 0, vertices); // 모든 원의 좌표를 한 번에 전송

  gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
  gl.bufferSubData(gl.ARRAY_BUFFER, 0, colors); // 모든 원의 색상을 한 번에 전송

  // 각 원 그리기
  for (let i = 0; i < numCircles; i++) {
    const colorOffset = i * 4;
    gl.uniform4fv(colorLocation, colors.subarray(colorOffset, colorOffset + 4)); // 색상 업데이트
    gl.drawArrays(gl.TRIANGLE_FAN, i * segments, segments); // 각 원을 TRIANGLE_FAN으로 그리기
  }

  // 다음 프레임 요청
  requestAnimationFrame(animate);
}
