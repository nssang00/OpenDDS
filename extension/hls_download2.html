<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Stream Downloader with Custom Fragment Loader</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/mux.js@latest"></script>
</head>
<body>
    <h1>HLS Stream Downloader with Custom Fragment Loader</h1>

    <!-- 비디오 플레이어 -->
    <video id="video" controls width="640" height="360"></video>

    <!-- 다운로드 및 변환 버튼들 -->
    <div>
        <label><input type="radio" name="format" value="mp4" checked> MP4</label>
        <label><input type="radio" name="format" value="ts"> TS</label>
        <button id="downloadBtn">Download</button>
        <button id="startAutoSaveBtn">Start Auto Save</button>
        <button id="stopAutoSaveBtn">Stop Auto Save</button>
    </div>

    <script>
        // 세그먼트를 저장할 배열
        const segments = {
            video: [],
            audio: []
        };
        let autoSaveInterval = null;
        const autoSaveDuration = 600000; // 10분마다 자동 저장 (600,000ms = 10분)

        // 커스텀 프래그먼트 로더 (TS 세그먼트 처리)
        class CustomFragLoader extends Hls.DefaultConfig.loader {
            constructor(config) {
                super(config);
            }

            load(context, config, callbacks) {
                if (context.type === 'fragment') {
                    console.log('Custom fragLoader for TS segment:', context.frag.url);
                }

                // 기본 프래그먼트 로딩 유지
                super.load(context, config, {
                    onSuccess: (response, stats, context) => {
                        if (context.type === 'fragment') {
                            const segment = new Uint8Array(response.data);
                            console.log('TS Segment loaded:', segment);

                            // TS 세그먼트 데이터를 저장
                            segments.video.push(segment);
                        }

                        // 성공 콜백 처리
                        callbacks.onSuccess(response, stats, context);
                    },
                    onError: callbacks.onError,
                    onTimeout: callbacks.onTimeout,
                });
            }
        }

        // HLS.js 설정 및 초기화
        if (Hls.isSupported()) {
            const video = document.getElementById('video');
            const hls = new Hls({
                fragLoader: CustomFragLoader // 커스텀 프래그먼트 로더 사용
            });
            hls.loadSource('https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'); // 테스트용 스트림 URL
            hls.attachMedia(video);
        }

        // Mux.js를 사용하여 MP4 파일로 변환
        function convertToMP4() {
            const transmuxer = new muxjs.mp4.Transmuxer();
            let mp4data = [];

            transmuxer.on('data', (segment) => {
                mp4data.push(segment.initSegment);
                mp4data.push(segment.data);
            });

            transmuxer.on('done', () => {
                downloadMP4(mp4data);
            });

            // 비디오 세그먼트를 transmuxer로 푸시
            segments.video.forEach((segment) => {
                transmuxer.push(segment);
            });

            transmuxer.flush();
        }

        // MP4 파일 다운로드
        function downloadMP4(mp4data) {
            const blob = new Blob(mp4data, { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'live_stream.mp4';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // TS 파일 병합 후 다운로드
        function mergeAndDownloadTS() {
            const videoBlob = new Blob(segments.video, { type: 'video/mp2t' });
            const url = URL.createObjectURL(videoBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'live_stream.ts';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 다운로드 버튼 핸들러
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const format = document.querySelector('input[name="format"]:checked').value;
            if (format === 'mp4') {
                convertToMP4();
            } else {
                mergeAndDownloadTS();
            }
        });

        // 자동 저장 기능
        function startAutoSave() {
            if (!autoSaveInterval) {
                autoSaveInterval = setInterval(() => {
                    console.log("자동으로 TS 파일 저장 중...");
                    mergeAndDownloadTS();
                }, autoSaveDuration);
                alert("자동 저장이 시작되었습니다. 10분마다 TS 파일이 저장됩니다.");
            }
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                alert("자동 저장이 중지되었습니다.");
            }
        }

        // 자동 저장 시작 및 중지 버튼 핸들러
        document.getElementById('startAutoSaveBtn').addEventListener('click', startAutoSave);
        document.getElementById('stopAutoSaveBtn').addEventListener('click', stopAutoSave);
    </script>
</body>
</html>
