<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Stream Downloader with Auto-Save</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/mux.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@latest/dist/ffmpeg.min.js">
</head>
<body>
    <h1>HLS Stream Downloader with Auto-Save</h1>

    <!-- 비디오 플레이어 -->
    <video id="video" controls width="640" height="360"></video>

    <!-- 다운로드 및 변환 버튼들 -->
    <div>
        <label><input type="radio" name="format" value="mp4" checked> MP4</label>
        <label><input type="radio" name="format" value="ts"> TS</label>
        <button id="downloadBtn">Download</button>
        <button id="startAutoSaveBtn">Start Auto Save</button>
        <button id="stopAutoSaveBtn">Stop Auto Save</button>
    </div>

    <script>
        // 세그먼트를 저장할 배열
        const segments = {
            video: [],
            audio: []
        };
        let autoSaveInterval = null;
        const autoSaveDuration = 600000; // 10분마다 자동 저장 (600,000ms = 10분)

        // HLS.js 설정 및 초기화
        if (Hls.isSupported()) {
            const video = document.getElementById('video');
            const hls = new Hls();
            hls.loadSource('https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'); // 테스트용 스트림 URL
            hls.attachMedia(video);

            // 데이터가 버퍼에 추가될 때마다 호출되는 이벤트
            hls.on(Hls.Events.BUFFER_APPENDING, function(event, data) {
                if (data.type === 'video' || data.type === 'audio') {
                    // 데이터는 Uint8Array 형식으로 변환되어야 합니다
                    const segment = new Uint8Array(data.data);
                    segments[data.type].push(segment);
                }
            });
        }

        // Mux.js를 사용하여 MP4 파일로 변환
        function convertToMP4() {
            const transmuxer = new muxjs.mp4.Transmuxer();

            // MP4 데이터 저장 배열 초기화
            let mp4data = [];

            // `data` 이벤트 핸들러
            transmuxer.on('data', (segment) => {
                console.log("MP4 Data received:", segment);
                mp4data.push(segment.initSegment);
                mp4data.push(segment.data);
            });

            // `done` 이벤트 핸들러
            transmuxer.on('done', () => {
                console.log("MP4 Transmuxing done.");
                downloadMP4();  // 변환이 완료된 후에 다운로드 실행
            });

            // `error` 이벤트 핸들러
            transmuxer.on('error', (error) => {
                console.error('Transmuxer Error:', error);
            });

            // 비디오 및 오디오 세그먼트를 transmuxer로 푸시
            Object.keys(segments).forEach((type) => {
                segments[type].forEach((segment) => {
                    console.log(`Pushing ${type} segment to transmuxer`);
                    transmuxer.push(segment); // Uint8Array로 푸시
                });
            });

            // 변환 후 flush 호출
            transmuxer.flush();
        }

        // MP4 파일을 Blob으로 만들어 다운로드
        function downloadMP4() {
            const blob = new Blob(mp4data, { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'live_stream.mp4';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // TS 파일을 병합하여 다운로드
        function mergeAndDownloadTS() {
            // 모든 세그먼트를 하나로 병합
            const videoBlob = new Blob(segments.video, { type: 'video/mp2t' });
            const audioBlob = new Blob(segments.audio, { type: 'audio/mp2t' });
            const combinedBlob = new Blob([videoBlob, audioBlob], { type: 'video/mp2t' });

            // 병합된 TS 파일 다운로드
            const url = URL.createObjectURL(combinedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'live_stream.ts';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 다운로드 버튼 핸들러
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const format = document.querySelector('input[name="format"]:checked').value;
            if (format === 'mp4') {
                convertToMP4();  // MP4로 변환 후 다운로드
            } else {
                mergeAndDownloadTS();  // TS 병합 후 다운로드
            }
        });

        // 자동 저장 기능 시작
        function startAutoSave() {
            if (!autoSaveInterval) {
                autoSaveInterval = setInterval(() => {
                    console.log("자동으로 TS 파일 저장 중...");
                    mergeAndDownloadTS(); // 일정 시간마다 TS 파일 병합 및 다운로드
                }, autoSaveDuration);
                alert("자동 저장이 시작되었습니다. 10분마다 TS 파일이 저장됩니다.");
            }
        }

        // 자동 저장 기능 중지
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                alert("자동 저장이 중지되었습니다.");
            }
        }

        // 자동 저장 시작 버튼 핸들러
        document.getElementById('startAutoSaveBtn').addEventListener('click', () => {
            startAutoSave();
        });

        // 자동 저장 중지 버튼 핸들러
        document.getElementById('stopAutoSaveBtn').addEventListener('click', () => {
            stopAutoSave();
        });
    </script>
</body>
</html>
